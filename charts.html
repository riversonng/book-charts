<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“Š GrÃ¡ficos da Biblioteca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<style>


body {
  margin: 0;
  padding: 24px;
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
}
/* ========================================= */
/* HEADER */
/* ========================================= */
header {
  max-width: 1100px;
  margin: 0 auto 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  margin: 0;
  font-size: 22px;
  font-weight: 600;
  color: var(--text);
}

.header-buttons {
  display: flex;
  gap: 8px;
}

.header-buttons button {
  background: var(--accent);
  border: 1px solid var(--chip-border);
  border-radius: 8px;
  color: var(--text);
  padding: 6px 10px;
  font-size: 14px;
  cursor: pointer;
  transition: 0.2s;
}

.header-buttons button:hover {
  background: color-mix(in srgb, var(--accent) 80%, var(--chip));
}

/* SubtÃ­tulo / texto secundÃ¡rio */
.sub {
  color: var(--muted);
  font-size: 13px;
}

/* ========================================= */
/* CONTROLS */
/* ========================================= */
.controls {
  display: grid;
  gap: 12px;
  max-width: 1100px;
  justify-content: center;
  grid-template-columns: 1fr auto auto auto auto auto auto;
  margin: 16px auto;
  align-items: center;
}

.controls input,
.controls select,
.controls button,
#back {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--chip-border);
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 14px;
}

.controls button,
#back {
  cursor: pointer;
  background: var(--accent);
  border-color: var(--chip-border);
}

.controls button:hover,
#back:hover {
  background: color-mix(in srgb, var(--accent) 80%, var(--chip));
}

/* ========================================= */
/* ESTATÃSTICAS */
/* ========================================= */
.stats {
  max-width: 1100px;
  margin: 20px auto;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}

.stat {
  background: var(--card);
  border: 1px solid var(--chip-border);
  border-radius: 10px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center;
}

.stat b {
  color: var(--muted);
  font-size: 14px;
  margin-bottom: 6px;
}

.stat .val {
  font-size: 14px;
  color: var(--text);
}

/* Agrupamentos de stats ocupando a linha inteira */
.stat-group {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

/* ========================================= */
/* GRÃFICOS */
/* ========================================= */

.charts-grid {
  max-width: 1100px;
  margin: 20px auto;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  
}

.chart-card {
  background: var(--card);
  border: 1px solid var(--chip-border);
  border-radius: 10px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  
}

.chart-card h3 {
  font-size: 18px;
  font-weight: 600;
  margin: 0 0 16px 0;
  text-align: center;
  align-self: flex-start;
  
}

.chart {
  display: flex;
  align-items: flex-end;
  gap: 10px;
  height: 300px;
  width: 100%;
  margin-top: 16px;
}

.bar {
  width: 100%;
  border-radius: 4px 4px 0 0;
  text-align: center;
  font-size: 14px;
  font-weight: bold;
  display: flex;
  align-items: flex-start;   /* texto no fundo da barra */
  justify-content: center;
  padding-bottom: 4px;     /* espaÃ§o para o nÃºmero */
  box-sizing: border-box;  /* garante que padding nÃ£o estoure a altura */
}

.bar-label {
  margin-top: 6px;
  font-size: 13px;
  color: var(--accent);
  text-align: center;
}


/* ========================================= */
/* CHIPS */
/* ========================================= */
.chip {
  border: 1px solid color-mix(in srgb, var(--accent) 55%, var(--chip-border));
  font-size: 11px;
  padding: 6px 8px;
  border-radius: 999px;
  color: var(--text);
  background: color-mix(in srgb, var(--accent) 25%, var(--card));
}

/* ========================================= */
/* TEMAS DISPONÃVEIS */
/* ========================================= */
.theme-dark {
  --bg: #0d1117;
  --card: #161b22;
  --text: #e6edf3;
  --muted: #8b98a5;
  --accent: #3ea6ff;
  --chip: #1f2935;
  --chip-border: #2d3a48;
}

.theme-neon {
  --bg: #070708;
  --card: #131318;
  --text: #ffffff;
  --muted: #cccccc;
  --accent: #ff40d8;
  --chip: #1d1d25;
  --chip-border: #4a4a65;
}

.theme-dark-academia {
  --bg: #1f1b17;
  --card: #493b30;
  --text: #f7f2e7;
  --muted: #ddd5ca;
  --accent: #ebac6d;
  --chip: #3a3028;
  --chip-border: #6b5848;
}

.theme-skoob {
  --bg: #e6f0fa;
  --card: #ffffff;
  --text: #1a1a1a;
  --muted: #555;
  --accent: #0077cc;
  --chip: #d9e9f7;
  --chip-border: #aacce0;
}

.theme-tumblr {
  --bg: #36465d;
  --card: #465a77;
  --text: #ffffff;
  --muted: #cfd6e0;
  --accent: #9b59b6;
  --chip: #529ECC;
  --chip-border: #5a6b85;
}

.theme-gray {
  --bg: #2c2c2c;
  --card: #363636;
  --text: #ffffff;
  --muted: #888;
  --accent: #ffcc00;
  --chip: #444;
  --chip-border: #666;
}

/* ========================================= */
/* BOTÃ•ES DE TEMAS (corrigidos!) */
/* ========================================= */

.themes {
  display: flex;
  gap: 8px;
  margin: 12px 0;
}


/* CORES FIXAS DAS BOLINHAS */
.theme-option {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.1); /* leve transparÃªncia */
}

.theme-option.theme-dark {
  border-color: #171b27;
  background: rgba(23, 27, 39, 0.3);
}

.theme-option.theme-dark-academia {
  border-color: #c08a5c;
  background: rgba(192, 138, 92, 0.3);
}

.theme-option.theme-skoob {
  border-color: #0074d9;
  background: rgba(0, 116, 217, 0.3);
}

.theme-option.theme-tumblr {
  border-color: #44536d;
  background: rgba(68, 83, 109, 0.3);
}

.theme-option.theme-gray {
  border-color: #3a3a41;
  background: rgba(58, 58, 65, 0.3);
}

/* Efeito hover */
.theme-option:hover {
  transform: scale(1.2);
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}


</style>

  </head>
<body>
  <header>
    <h1>ğŸ“Š GrÃ¡ficos da Biblioteca</h1>

     <div class="themes">
    <div class="theme-option theme-dark" onclick="setTheme('theme-dark')"></div>
    <div class="theme-option theme-dark-academia" onclick="setTheme('theme-dark-academia')"></div>
    <div class="theme-option theme-skoob" onclick="setTheme('theme-skoob')"></div>
    <div class="theme-option theme-tumblr" onclick="setTheme('theme-tumblr')"></div>
    <div class="theme-option theme-gray" onclick="setTheme('theme-gray')"></div>
  </div>

    <div class="header-buttons">
      <button id="back">ğŸ“š</button>
      <button id="charts">ğŸ“Š</button>
      <button id="tags">ğŸ·ï¸</button>
      <button id="flashback">ğŸŒŸ</button>

    </div>
</header>
   <div class="controls">
      <input id="q" type="search" placeholder="Buscar por tÃ­tulo, autor, sÃ©rie, tags ou ISBN..." />
      <select id="year"><option value="">Ano</option></select>
      <select id="month"><option value="">MÃªs</option></select>
      <select id="lang"><option value="">Linguagem</option></select>
      <select id="format"><option value="">Formato</option><option value="K">Kindle</option><option value="F">FÃ­sico</option></select>
      <button id="clear">â†»</button>
</div>


<!-- Cards estatÃ­sticos reorganizados -->
<section class="stats" id="stats">
  <!-- EstatÃ­sticas gerais -->
<div class="stat">
    <b>Total de livros</b>
    <div class="val" id="stat-count">â€“</div>
  </div>
  <div class="stat">
    <b>Total de pÃ¡ginas</b>
    <div class="val" id="stat-pages">â€“</div>
  </div>
  <div class="stat">
    <b>Nota mÃ©dia</b>
    <div class="val" id="stat-rating">â€“</div>
  </div>
  <div class="stat">
    <b>Favoritos</b>
    <div class="val" id="stat-fav">â€“</div>
  </div>
  <div class="stat">
    <b>Nota 5</b>
    <div class="val" id="stat-5">â€“</div>
  </div>

  <!-- Separador visual -->
  <div style="grid-column: 1 / -1; height: 1px; background: var(--accent); margin: 4px 0;"></div>

  <!-- Agrupamento por Formato -->
  <div class="stat">
    <b>ğŸ“± Kindle</b>
    <div class="val">â˜… <span id="stat-maiorK">â€“</span></div>
    <div class="val">â˜† <span id="stat-menorK">â€“</span></div>
  </div>
  <div class="stat">
    <b>ğŸ“– FÃ­sico</b>
    <div class="val">â˜… <span id="stat-maiorF">â€“</span></div>
    <div class="val">â˜† <span id="stat-menorF">â€“</span></div>
  </div>

  <!-- Agrupamento por Idioma -->
  <div class="stat">
    <b>ğŸ‡§ğŸ‡· PortuguÃªs (PT)</b>
<div class="val">â˜… <span id="stat-maiorPT">â€“</span></div>
<div class="val">â˜† <span id="stat-menorPT">â€“</span></div>
  </div>
  <div class="stat">
    <b>ğŸ‡ºğŸ‡¸ InglÃªs (IN)</b>
    <div class="val">â˜… <span id="stat-maiorEN">â€“</span></div>
    <div class="val">â˜† <span id="stat-menorEN">â€“</span></div>
  </div>
  <div class="stat">
  <b>ğŸ“±ğŸ“– Pags/Formato</b>
  <div class="val">ğŸ“± <span id="stat-mediaK">â€“</span></div>
  <div class="val">ğŸ“– <span id="stat-mediaF">â€“</span></div>
</div>

</section>


  <main class="grid">

<div class="charts-grid">
  <div class="chart-card">
    <h3>ğŸ“Š Livros por Ano</h3>
    <div id="chart-livros-ano" class="chart"></div>
  </div>
  <div class="chart-card">
    <h3>ğŸ“Š Livros por MÃªs</h3>
    <div id="chart-livros-mes" class="chart"></div>
  </div>
  <div class="chart-card">
    <h3>ğŸ“Š MÃ©dia de PÃ¡ginas/Ano</h3>
    <div id="chart-paginas-ano" class="chart"></div>
  </div>
  <div class="chart-card">
    <h3>ğŸ“Š MÃ©dia de Notas/Ano</h3>
    <div id="chart-notas-ano" class="chart"></div>
  </div>
</div>


</main>

<script>
const mesesOrdem = ["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const state = { data: [], filtered: [], q:"", year:"", month:"", lang:"", format:"" };

// Carregar dados
fetch("./books.json")
  .then(r => r.json())
  .then(data => {
    state.data = Array.isArray(data) ? data : [];
    populateFilters(state.data);
    applyFilters();
  });

// FunÃ§Ãµes utilitÃ¡rias
function normalize(s) {
  return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function getTags(b) {
  return [b.TAG1,b.TAG2,b.TAG3].filter(t=>t);
}

// Aplicar filtros
function applyFilters() {
  const qn = normalize(state.q);
  state.filtered = state.data.filter(b => {
    const tagsN = getTags(b).map(t=>normalize(t));
    return (!qn || normalize(b.TITLE).includes(qn) || normalize(b.AUTHOR).includes(qn) || tagsN.some(t=>t.includes(qn)))
        && (!state.year || String(b.YEAR) === String(state.year))
        && (!state.month || String(b.MONTH) === String(state.month))
        && (!state.lang || String(b.LANGUAGE) === String(state.lang))
        && (!state.format || String(b.FORMAT) === String(state.format));
  });
  renderStats(state.filtered);
  renderCharts(state.filtered);
}

// Renderizar estatÃ­sticas
function renderStats(list) {
  const setText = (id, val) => document.getElementById(id).textContent = val;
  setText("stat-count", list.length);
  setText("stat-pages", list.reduce((a,b)=>a+(+b.PAGES||0),0));
  setText("stat-rating", (list.reduce((a,b)=>a+(+b.RATING||0),0)/(list.length||1)).toFixed(2));
  setText("stat-fav", list.filter(b=>(b.FAV||"").toUpperCase()==="YES").length);
  setText("stat-5", list.filter(b=>(+b.RATING)===5).length);

  const formatStats = (arr) => {
    const maior = arr.reduce((a,b)=>(+b.PAGES>(+a.PAGES||0)?b:a), {});
    const menor = arr.reduce((a,b)=>(+b.PAGES<(+a.PAGES||Infinity)?b:a), {});
    return {
      maior: maior.TITLE ? `${maior.TITLE} (${maior.PAGES} pÃ¡g)` : "â€“",
      menor: menor.TITLE ? `${menor.TITLE} (${menor.PAGES} pÃ¡g)` : "â€“",
      media: arr.length ? (arr.reduce((a,b)=>a+(+b.PAGES||0),0)/arr.length).toFixed(1) : "â€“"
    };
  };

  const kindle = formatStats(list.filter(b=>b.FORMAT==="K"));
  const fisico = formatStats(list.filter(b=>b.FORMAT==="F"));
  setText("stat-maiorK", kindle.maior); setText("stat-menorK", kindle.menor); setText("stat-mediaK", kindle.media);
  setText("stat-maiorF", fisico.maior); setText("stat-menorF", fisico.menor); setText("stat-mediaF", fisico.media);

  const ptStats = formatStats(list.filter(b=>String(b.LANGUAGE).toUpperCase()==="PT"));
  const enStats = formatStats(list.filter(b=>String(b.LANGUAGE).toUpperCase()==="IN"));
  setText("stat-maiorPT", ptStats.maior); setText("stat-menorPT", ptStats.menor);
  setText("stat-maiorEN", enStats.maior); setText("stat-menorEN", enStats.menor);
}

// Agrupar e calcular mÃ©dia
function groupBy(arr,key) {
  return arr.reduce((acc,o)=>{
    if(o[key]) acc[o[key]]=(acc[o[key]]||0)+1;
    return acc;
  },{});
}
function avgByYear(arr,key) {
  const grouped = {};
  arr.forEach(b=>{
    if(b.YEAR) {
      if(!grouped[b.YEAR]) grouped[b.YEAR] = [];
      grouped[b.YEAR].push(+b[key]||0);
    }
  });
  return Object.fromEntries(Object.entries(grouped).map(([y,v])=>[y,(v.reduce((a,b)=>a+b,0)/v.length).toFixed(1)]));
}

// Renderizar grÃ¡fico de barras com escala de cores
// Renderizar grÃ¡fico de barras com escala de cores
function renderBarChart(containerId, dataObj) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  const maxHeight = container.clientHeight || 280;
  const values = Object.values(dataObj);
  const maxVal = Math.max(...values, 1);

  // Sempre pega a cor atual do tema
const baseColor = getComputedStyle(document.body)
                    .getPropertyValue('--accent').trim();

  Object.entries(dataObj).forEach(([label, value], idx, arr)=>{
    const wrapper = document.createElement("div");
    wrapper.style.flex="1"; 
    wrapper.style.display="flex"; 
    wrapper.style.flexDirection="column";
    wrapper.style.alignItems="center"; 
    wrapper.style.justifyContent="flex-end";

    const bar = document.createElement("div");
    bar.className="bar";
    bar.style.height=((+value/maxVal)*maxHeight)+"px";

    // Escalonar cor conforme posiÃ§Ã£o
    const factor = 0.6 + 0.4 * (idx / (arr.length-1 || 1));
    bar.style.background = adjustColorBrightness(baseColor, factor);

    bar.textContent = value;

    const lbl = document.createElement("div");
    lbl.className="bar-label"; 
    lbl.textContent=label;

    wrapper.appendChild(bar); 
    wrapper.appendChild(lbl); 
    container.appendChild(wrapper);
  });
}

function renderCharts(list) {
  renderBarChart("chart-livros-ano", groupBy(list,"YEAR"));
  renderBarChart("chart-livros-mes", groupBy(list,"MONTH"));
  renderBarChart("chart-paginas-ano", avgByYear(list,"PAGES"));
  renderBarChart("chart-notas-ano", avgByYear(list,"RATING"));
}

// Ajusta brilho de uma cor HEX ou RGB
function adjustColorBrightness(col, factor) {
  let r, g, b;
  if(col.startsWith("#")) {
    r=parseInt(col.substr(1,2),16);
    g=parseInt(col.substr(3,2),16);
    b=parseInt(col.substr(5,2),16);
  } else if(col.startsWith("rgb")) {
    [r,g,b] = col.match(/\d+/g).map(Number);
  } else return col;
  r = Math.min(255, Math.round(r*factor));
  g = Math.min(255, Math.round(g*factor));
  b = Math.min(255, Math.round(b*factor));
  return `rgb(${r},${g},${b})`;
}

// Popular filtros
function populateFilters(data){
  const yearSel=document.getElementById("year");
  const monthSel=document.getElementById("month");
  const langSel=document.getElementById("lang");

  [...new Set(data.map(d=>d.YEAR))].filter(Boolean).sort((a,b)=>a-b).forEach(y=>{
    const opt=document.createElement("option"); opt.value=y; opt.textContent=y; yearSel.appendChild(opt);
  });

  mesesOrdem.forEach(m=>{
    const opt=document.createElement("option"); opt.value=m; opt.textContent=m; monthSel.appendChild(opt);
  });

  [...new Set(data.map(d=>String(d.LANGUAGE).toUpperCase()))].filter(Boolean).sort().forEach(l=>{
    const opt=document.createElement("option"); opt.value=l; opt.textContent=l; langSel.appendChild(opt);
  });
}

// Tema
function setTheme(themeClass){
  document.body.className=themeClass;
  localStorage.setItem("selectedTheme", themeClass);
  applyFilters(); // forÃ§a redesenho dos grÃ¡ficos jÃ¡ com a nova cor
}

document.addEventListener("DOMContentLoaded", ()=>{
  document.body.className = localStorage.getItem("selectedTheme") || "theme-dark";
});

// NavegaÃ§Ã£o
["charts","tags","flashback"].forEach(id=>{
  document.getElementById(id)?.addEventListener("click",()=> location.href = id+".html");
});
document.getElementById("back")?.addEventListener("click",()=> location.href="index.html");

// Eventos filtros
["q","year","month","lang","format"].forEach(id=>{
  const ev = (id==="q") ? "input" : "change";
  document.getElementById(id).addEventListener(ev, e=>{
    state[id] = e.target.value;
    applyFilters();
  });
});
document.getElementById("clear").addEventListener("click",()=>{
  ["q","year","month","lang","format"].forEach(id=>{
    state[id]="";
    document.getElementById(id).value="";
  });
  applyFilters();
});
</script>


</body>
</html>
